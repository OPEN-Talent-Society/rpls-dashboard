services:
  # Runner for AI-Enablement-Academy organization
  runner-aea:
    build:
      context: .
      dockerfile: Dockerfile
    image: github-runner-optimized:latest
    container_name: github-runner-aea
    restart: unless-stopped
    environment:
      ORG_NAME: AI-Enablement-Academy
      ACCESS_TOKEN: ${GITHUB_PAT}
      RUNNER_NAME: docker-runner-aea-1
      RUNNER_WORKDIR: /tmp/runner-aea/work
      RUNNER_GROUP: default
      RUNNER_SCOPE: org
      LABELS: docker,self-hosted,linux,x64,bun,node20,playwright,lighthouse,aea
      EPHEMERAL: false
      # Performance: Skip tool installation in jobs (already installed)
      ACTIONS_RUNNER_HOOK_JOB_STARTED: ""
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-data/aea:/tmp/runner-aea
      # Shared caches for faster builds
      - ./cache/bun:/root/.bun/install/cache
      - ./cache/npm:/root/.npm
      - ./cache/pnpm:/root/.local/share/pnpm/store
      # Playwright browsers are baked into image, but cache results
      - ./cache/playwright:/root/.cache/ms-playwright-results
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 3G
    networks:
      - runner-network
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Runner.Listener"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Runner for OPEN-Talent-Society organization
  runner-ots:
    build:
      context: .
      dockerfile: Dockerfile
    image: github-runner-optimized:latest
    container_name: github-runner-ots
    restart: unless-stopped
    environment:
      ORG_NAME: OPEN-Talent-Society
      ACCESS_TOKEN: ${GITHUB_PAT}
      RUNNER_NAME: docker-runner-ots-1
      RUNNER_WORKDIR: /tmp/runner-ots/work
      RUNNER_GROUP: default
      RUNNER_SCOPE: org
      LABELS: docker,self-hosted,linux,x64,bun,node20,playwright,lighthouse,ots
      EPHEMERAL: false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-data/ots:/tmp/runner-ots
      - ./cache/bun:/root/.bun/install/cache
      - ./cache/npm:/root/.npm
      - ./cache/pnpm:/root/.local/share/pnpm/store
      - ./cache/playwright:/root/.cache/ms-playwright-results
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 3G
    networks:
      - runner-network
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Runner.Listener"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Runner for The-Talent-Foundation organization
  runner-ttf:
    build:
      context: .
      dockerfile: Dockerfile
    image: github-runner-optimized:latest
    container_name: github-runner-ttf
    restart: unless-stopped
    environment:
      ORG_NAME: The-Talent-Foundation
      ACCESS_TOKEN: ${GITHUB_PAT}
      RUNNER_NAME: docker-runner-ttf-1
      RUNNER_WORKDIR: /tmp/runner-ttf/work
      RUNNER_GROUP: default
      RUNNER_SCOPE: org
      LABELS: docker,self-hosted,linux,x64,bun,node20,playwright,lighthouse,ttf
      EPHEMERAL: false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-data/ttf:/tmp/runner-ttf
      - ./cache/bun:/root/.bun/install/cache
      - ./cache/npm:/root/.npm
      - ./cache/pnpm:/root/.local/share/pnpm/store
      - ./cache/playwright:/root/.cache/ms-playwright-results
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 3G
    networks:
      - runner-network
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Runner.Listener"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Runner for personal repos (adambkovacs)
  # NOTE: GitHub personal accounts don't support user-level runners like organizations.
  # Personal repos require repo-level runner registration. To use this:
  # 1. Go to a specific repo > Settings > Actions > Runners > Add self-hosted runner
  # 2. Set REPO_URL to that specific repo (e.g., https://github.com/adambkovacs/my-repo)
  # 3. Uncomment and configure below
  # For now, personal repos can use GitHub-hosted runners.
  runner-personal:
    build:
      context: .
      dockerfile: Dockerfile
    image: github-runner-optimized:latest
    container_name: github-runner-personal
    restart: unless-stopped
    environment:
      # Personal repos use ORG_NAME with username for user-level runner
      ORG_NAME: adambkovacs
      ACCESS_TOKEN: ${GITHUB_PAT}
      RUNNER_NAME: docker-runner-personal-1
      RUNNER_WORKDIR: /tmp/runner-personal/work
      RUNNER_GROUP: default
      LABELS: docker,self-hosted,linux,x64,bun,node20,playwright,lighthouse,personal
      EPHEMERAL: false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-data/personal:/tmp/runner-personal
      - ./cache/bun:/root/.bun/install/cache
      - ./cache/npm:/root/.npm
      - ./cache/pnpm:/root/.local/share/pnpm/store
      - ./cache/playwright:/root/.cache/ms-playwright-results
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 3G
    networks:
      - runner-network
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Runner.Listener"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Watchtower for auto-updates (watches for new base image versions)
  watchtower:
    image: containrrr/watchtower:latest
    container_name: runner-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_CLEANUP: true
      WATCHTOWER_POLL_INTERVAL: 86400  # Check daily
      WATCHTOWER_INCLUDE_STOPPED: true
      # Only watch specific containers, not the custom-built ones
      WATCHTOWER_LABEL_ENABLE: true
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    networks:
      - runner-network

networks:
  runner-network:
    driver: bridge
